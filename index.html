<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smartphone Hidden Camera Detector</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Audio element for buzzer sound -->
    <audio id="buzzerSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            background: radial-gradient(circle, #0f2027, #203a43, #2c5364);
            color: #00fff5;
            text-align: center;
            padding: 20px;
            font-family: 'Poppins', sans-serif;
        }
        h1 {
            font-size: 2rem;
            color: #00f0ff;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00fff5, 0 0 20px #00fff5;
        }
        #video {
            border: 3px solid #00fff5;
            border-radius: 15px;
            box-shadow: 0 0 20px #00fff5;
            max-width: 100%;
        }
        #strengthBar {
            width: 80%;
            height: 25px;
            margin-top: 20px;
            accent-color: #00fff5;
        }
        .alert-text {
            font-size: 1.2rem;
            color: #ff004c;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,0,76,0.15);
            border: 2px solid #ff004c;
            border-radius: 10px;
            text-shadow: 0 0 10px #ff004c;
            display: none;
            animation: blink 0.8s infinite alternate;
        }
        @keyframes blink { from {opacity:1;} to{opacity:0.5;} }
        .slider-and-button { margin-top: 20px; color: #00fff5; }
        input[type=range] { width: 60%; accent-color: #00fff5; }
        .neon-btn {
            display:inline-block;
            padding:12px 20px;
            color:#00fff5;
            font-size:1rem;
            border:2px solid #00fff5;
            border-radius:10px;
            background:transparent;
            margin:10px;
            transition:0.3s;
            cursor: pointer;
        }
        .neon-btn:hover {
            background:#00fff5;
            color:#000;
            box-shadow:0 0 15px #00fff5;
        }
        .sharing-active {
            background: #ff0000 !important;
            color: white !important;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        #map {
            height: 400px;
            width: 100%;
            border: 1px solid #00fff5;
            border-radius: 10px;
            box-shadow: 0 0 10px #00fff5;
            margin: 20px 0;
            display: none;
            position: relative;
            z-index: 1;
        }
        .map-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px auto;
            max-width: 95%;
            width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
        }
        #policeStations {
            background: rgba(0, 255, 245, 0.1);
            border: 1px solid #00fff5;
            border-radius: 10px;
            padding: 15px;
            color: #00fff5;
        }
        .stations-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .accuracy-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ff0000;
            margin-right: 5px;
        }
        .accuracy-good {
            background-color: #00ff00;
        }
        .accuracy-medium {
            background-color: #ffff00;
        }
        .accuracy-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <h1>üö® Smartphone Hidden Camera Detector</h1>

    <video id="video" width="100%" height="auto" autoplay playsinline></video>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

    <progress id="strengthBar" value="0" max="100"></progress>
    <div class="alert-text" id="alertText">‚ö†Ô∏è Potential Hidden Camera Detected!</div>

    <div class="slider-and-button">
        <label>Sensitivity (Threshold): <span id="thresholdValue">240</span></label><br>
        <input type="range" id="thresholdRange" min="200" max="255" value="240">
        <div class="button-group">
            <button class="neon-btn" id="switchButton">Switch Camera üîÑ</button>
            <button class="neon-btn" id="cameraOffButton" style="background-color: #ff4d4d;">Turn Camera Off üî¥</button>
        </div>
        <div class="button-group">
            <button class="neon-btn" id="shareLocationButton">Share Location üìç</button>
            <button class="neon-btn" id="showMapButton">Show Map üó∫Ô∏è</button>
        </div>
    </div>

    <div class="map-container">
        <div id="map"></div>
        <div id="policeStations">
            <h3>Nearby Police Stations & Hospitals</h3>
            <div id="policeStationsList" class="stations-list">
                <p>Click "Show Map" & Wait</p>
            </div>
        </div>
    </div>
    
    <div id="coordinates" style="margin-top: 15px; padding: 15px; background: rgba(0, 255, 245, 0.1); border-radius: 5px; border: 1px solid #00fff5; color: #00fff5;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">Live Location Tracking</h3>
            <div id="accuracyIndicator" class="accuracy-indicator">
                <span class="accuracy-dot"></span>
                <span id="accuracyText">Accuracy: -- m</span>
            </div>
        </div>
        <div id="locationStatus" style="margin: 10px 0;">
            <p style="margin: 5px 0;">Click "Show Map" to start tracking your location</p>
        </div>
        <div id="lastUpdate" style="font-size: 0.9em; opacity: 0.8;"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // App state management
        const appState = {
            mapInstance: null,
            watchId: null,
            currentMarker: null,
            lastKnownPosition: null,
            sharedLocations: [],
            locationPolyline: null,
            currentStream: null,
            useRearCamera: true,
            mapShown: false,
            isDetecting: false,
            audioCtx: null,
            osc: null,
            gainNode: null,
            consecutiveCount: 0,  // Track consecutive detections
            lastDetectionTime: 0   // Track time of last detection
        };

        // Wait for DOM to be fully loaded
        document.addEventListener("DOMContentLoaded", function() {
            // Get DOM elements
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const strengthBar = document.getElementById("strengthBar");
            const alertText = document.getElementById("alertText");
            const thresholdRange = document.getElementById("thresholdRange");
            const thresholdValue = document.getElementById("thresholdValue");
            const startButton = document.getElementById("startButton");
            const switchButton = document.getElementById("switchButton");
            const shareLocationButton = document.getElementById("shareLocationButton");
            const showMapButton = document.getElementById("showMapButton");
            const mapDiv = document.getElementById("map");
            const policeStationsList = document.getElementById("policeStationsList");
            const locationStatus = document.getElementById("locationStatus");
            const accuracyText = document.getElementById("accuracyText");
            const accuracyDot = document.querySelector('.accuracy-dot');
            const lastUpdate = document.getElementById("lastUpdate");

            // Initialize camera
            async function initCamera() {
                try {
                    if (appState.currentStream) {
                        appState.currentStream.getTracks().forEach(track => track.stop());
                    }
                    const constraints = {
                        video: {
                            facingMode: appState.useRearCamera ? { exact: "environment" } : "user",
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            frameRate: { ideal: 30, max: 60 }
                        },
                        audio: false
                    };
                    
                    // Try to get the rear camera first
                    try {
                        appState.currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (rearError) {
                        console.log("Rear camera not available, trying front camera");
                        constraints.video.facingMode = "user";
                        appState.currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                        appState.useRearCamera = false;
                    }
                    
                    video.srcObject = appState.currentStream;
                    await video.play();
                    
                    // Initialize audio context when camera is ready
                    if (!appState.audioCtx) {
                        appState.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        appState.osc = appState.audioCtx.createOscillator();
                        appState.gainNode = appState.audioCtx.createGain();
                        appState.osc.connect(appState.gainNode);
                        appState.gainNode.connect(appState.audioCtx.destination);
                        appState.osc.type = "sine";
                        appState.osc.frequency.value = 0;
                        appState.gainNode.gain.value = 0;
                        appState.osc.start();
                    }
                    
                } catch (err) {
                    console.error("Camera error:", err);
                    alert("Error accessing camera: " + (err.message || "Please ensure camera permissions are granted"));
                }
            }

            // Start detection
            function startDetection() {
                // If audio context is not initialized, it will be initialized when camera starts
                appState.isDetecting = true;
                appState.consecutiveCount = 0; // Reset detection counter
                detectLoop();
            }

            // Clean up audio and camera
            function cleanupAudio() {
                if (appState.gainNode) {
                    appState.gainNode.gain.value = 0;
                }
                if (alertText) {
                    alertText.style.display = "none";
                }
            }
            
            // Stop camera and detection
            function stopCamera() {
                if (appState.currentStream) {
                    appState.currentStream.getTracks().forEach(track => track.stop());
                    video.style.display = 'none';
                    cleanupAudio();
                }
            }

            // Play buzzer sound
            function playBuzzer() {
                const buzzer = document.getElementById('buzzerSound');
                if (buzzer) {
                    buzzer.currentTime = 0; // Reset to start
                    buzzer.play().catch(e => console.log('Audio play failed:', e));
                }
            }

            // Stop buzzer sound
            function stopBuzzer() {
                const buzzer = document.getElementById('buzzerSound');
                if (buzzer) {
                    buzzer.pause();
                    buzzer.currentTime = 0;
                }
            }

            // Detection loop
            function detectLoop() {
                if (!appState.isDetecting) return;
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let brightSpots = 0;

                // Check central 200x200 area for better performance and focus
                const startX = Math.max(0, canvas.width / 2 - 100);
                const startY = Math.max(0, canvas.height / 2 - 100);
                const endX = Math.min(canvas.width, startX + 200);
                const endY = Math.min(canvas.height, startY + 200);
                
                // Sample every 5th pixel for better performance
                for (let y = startY; y < endY; y += 5) {
                    for (let x = startX; x < endX; x += 5) {
                        const i = (Math.floor(y) * canvas.width + Math.floor(x)) * 4;
                        const brightness = (frame.data[i] + frame.data[i+1] + frame.data[i+2]) / 3;
                        if (brightness > thresholdRange.value) brightSpots++;
                    }
                }

                const strength = Math.min(brightSpots, 200);
                const strengthPercentage = (strength / 200) * 100;
                
                // Update UI
                if (strengthBar) strengthBar.value = strengthPercentage;
                
                // Check threshold with consecutive count to reduce false positives
                if (strength > 5) {
                    appState.consecutiveCount = (appState.consecutiveCount || 0) + 1;
                } else {
                    appState.consecutiveCount = 0;
                }
                
                if (appState.consecutiveCount >= 5) {
                    // Potential camera detected
                    if (appState.gainNode) {
                        appState.gainNode.gain.value = 0.3;
                        appState.osc.frequency.value = 300 + strength * 2;
                    }
                    if (alertText) alertText.style.display = "block";
                    playBuzzer();
                } else {
                    if (appState.gainNode) appState.gainNode.gain.value = 0;
                    if (alertText) alertText.style.display = "none";
                    stopBuzzer();
                }
                
                requestAnimationFrame(detectLoop);
            }

            // Fetch nearby places from Overpass API
            async function fetchNearbyPlaces(lat, lng, radius = 1000) {
                const radiusInMeters = radius; // 1km radius
                const overpassUrl = 'https://overpass-api.de/api/interpreter';
                const query = `
                    [out:json];
                    (
                      node["amenity"="police"]
                        (around:${radiusInMeters},${lat},${lng});
                      node["amenity"="hospital"]
                        (around:${radiusInMeters},${lat},${lng});
                      way["amenity"="hospital"]
                        (around:${radiusInMeters},${lat},${lng});
                      relation["amenity"="hospital"]
                        (around:${radiusInMeters},${lat},${lng});
                    );
                    out body;
                    >;
                    out skel qt;
                `;

                try {
                    const response = await fetch(overpassUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        },
                        body: `data=${encodeURIComponent(query)}`
                    });
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const data = await response.json();
                    return data.elements || [];
                } catch (error) {
                    console.error('Error fetching places:', error);
                    return [];
                }
            }

            // Format phone number for display
            function formatPhoneNumber(phone) {
                if (!phone) return 'Not available';
                // Remove all non-digit characters except plus
                const cleaned = ('' + phone).replace(/[^0-9+]/g, '');
                // Format as per Indian phone numbers
                if (cleaned.startsWith('+')) {
                    // International format
                    return cleaned.replace(/(\+\d{2})(\d{5})(\d{5})/, '$1 $2 $3');
                } else if (cleaned.length === 10) {
                    // Indian mobile number
                    return cleaned.replace(/(\d{5})(\d{5})/, '$1 $2');
                } else if (cleaned.length > 10) {
                    // Landline with STD code
                    return cleaned.replace(/(\d{2,5})(\d{6,8})/, '$1 $2');
                }
                return cleaned;
            }
            
            // Calculate distance between two coordinates in kilometers
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Radius of the earth in km
                const dLat = deg2rad(lat2 - lat1);
                const dLon = deg2rad(lon2 - lon1);
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // Distance in km
            }
            
            function deg2rad(deg) {
                return deg * (Math.PI/180);
            }

            // Add markers for nearby places
            function addPlaceMarkers(places) {
                // Clear existing markers except user location
                if (appState.placeMarkers) {
                    appState.placeMarkers.forEach(marker => appState.mapInstance.removeLayer(marker));
                }
                
                appState.placeMarkers = [];
                let policeStations = [];
                let hospitals = [];

                places.forEach(place => {
                    const isPolice = place.tags?.amenity === 'police';
                    const icon = L.icon({
                        iconUrl: isPolice ? 'https://cdn-icons-png.flaticon.com/512/2838/2838912.png' : 
                                          'https://cdn-icons-png.flaticon.com/512/2785/2785813.png',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32]
                    });

                    // Prepare popup content
                    const name = place.tags?.name || 'Unnamed Place';
                    const address = [
                        place.tags?.['addr:street'],
                        place.tags?.['addr:city']
                    ].filter(Boolean).join(', ');
                    
                    const phone = place.tags?.phone || place.tags?.['contact:phone'] || '';
                    const website = place.tags?.website || '';
                    
                    let popupContent = `
                        <div style="min-width: 200px;">
                            <b>${name}</b><br>
                            ${address || 'Address not available'}<br>
                    `;
                    
                    if (phone) {
                        popupContent += `
                            <div style="margin-top: 5px;">
                                <i class="fas fa-phone"></i> 
                                <a href="tel:${phone}" style="color: #00bfff; text-decoration: none;">
                                    ${formatPhoneNumber(phone)}
                                </a>
                            </div>
                        `;
                    }
                    
                    if (website) {
                        popupContent += `
                            <div style="margin-top: 5px;">
                                <i class="fas fa-globe"></i> 
                                <a href="${website.startsWith('http') ? website : 'https://' + website}" 
                                   target="_blank" 
                                   style="color: #00bfff; text-decoration: none;">
                                    Website
                                </a>
                            </div>
                        `;
                    }
                    
                    popupContent += '</div>';

                    const marker = L.marker([place.lat, place.lon], { icon })
                        .addTo(appState.mapInstance)
                        .bindPopup(popupContent);

                    appState.placeMarkers.push(marker);

                    // Categorize places
                    if (isPolice) {
                        policeStations.push(place);
                    } else {
                        hospitals.push(place);
                    }
                });

                // Update places lists
                updatePlacesList('police', policeStations);
                updatePlacesList('hospital', hospitals);
            }

            // Format address from OSM tags
            function formatAddress(tags) {
                const addressParts = [
                    tags['addr:housenumber'],
                    tags['addr:street'],
                    tags['addr:suburb'] || tags['addr:neighbourhood'],
                    tags['addr:city'] || tags['addr:town'] || tags['addr:county'],
                    tags['addr:state'],
                    tags['addr:postcode']
                ].filter(Boolean);
                
                // If we couldn't build an address from parts, try the full address tag
                if (addressParts.length === 0 && tags['addr:full']) {
                    return tags['addr:full'];
                }
                
                return addressParts.join(', ');
            }

            // Format contact information
            function formatContactInfo(tags) {
                const contactInfo = [];
                if (tags.phone) {
                    const phoneNumbers = Array.isArray(tags.phone) ? tags.phone : [tags.phone];
                    phoneNumbers.forEach(phone => {
                        // Clean up phone number
                        const cleanPhone = phone.replace(/[^0-9+]/g, '');
                        contactInfo.push(`<div><i class="fas fa-phone"></i> <a href="tel:${cleanPhone}">${formatPhoneNumber(phone)}</a></div>`);
                    });
                }
                if (tags.website) {
                    const websites = Array.isArray(tags.website) ? tags.website : [tags.website];
                    websites.forEach(site => {
                        let url = site;
                        if (!url.match(/^https?:\/\//)) {
                            url = 'http://' + url;
                        }
                        contactInfo.push(`<div><i class="fas fa-globe"></i> <a href="${url}" target="_blank" rel="noopener noreferrer">${site.replace(/^https?:\/\//, '')}</a></div>`);
                    });
                }
                if (tags['contact:phone']) {
                    const phones = Array.isArray(tags['contact:phone']) ? tags['contact:phone'] : [tags['contact:phone']];
                    phones.forEach(phone => {
                        const cleanPhone = phone.replace(/[^0-9+]/g, '');
                        contactInfo.push(`<div><i class="fas fa-phone"></i> <a href="tel:${cleanPhone}">${formatPhoneNumber(phone)}</a> (Contact)</div>`);
                    });
                }
                return contactInfo.length > 0 ? contactInfo.join('') : 'Contact: Not available';
            }

            // Get phone number from various possible OSM tags
            function getPhoneNumber(tags) {
                // Check multiple possible phone number tags
                const phoneTags = [
                    'phone',
                    'contact:phone',
                    'contact:mobile',
                    'contact:whatsapp',
                    'emergency_phone',
                    'contact:emergency',
                    'emergency'
                ];
                
                for (const tag of phoneTags) {
                    if (tags[tag]) {
                        // Clean up the phone number
                        const phone = String(tags[tag]).split(';')[0].trim(); // Take first number if multiple
                        if (phone) return phone;
                    }
                }
                return '';
            }

            // Update places list in the UI
            function updatePlacesList(type, places) {
                const listElement = document.getElementById(`${type}StationsList`);
                if (!listElement) return;

                if (places.length === 0) {
                    listElement.innerHTML = `<p>No nearby ${type} stations found.</p>`;
                    return;
                }

                const listItems = places.map(place => {
                    const name = place.tags?.name || 'Unnamed Place';
                    const address = formatAddress(place.tags || {});
                    const phone = getPhoneNumber(place.tags || {});
                    const distance = place.distance ? `${Math.round(place.distance)}m` : '';
                    
                    let contactHtml = '';
                    // Only show contact numbers for hospitals
                    if (type === 'hospital' && phone) {
                        contactHtml = `
                            <div style="margin: 3px 0;">
                                <i class="fas fa-phone" style="width: 20px; color: #00bfff;"></i>
                                <a href="tel:${phone}" style="color: #00bfff; text-decoration: none;">
                                    ${formatPhoneNumber(phone)}
                                </a>
                            </div>`;
                    }

                    return `
                        <div class="place-item" style="margin: 10px 0; padding: 10px; border-left: 4px solid ${type === 'police' ? '#ff4444' : '#44ff44'};">
                            <h4 style="margin: 0 0 5px 0; color: white;">
                                <i class="fas ${type === 'police' ? 'fa-shield-alt' : 'fa-hospital'}" style="margin-right: 8px;"></i>
                                ${name}
                            </h4>
                            <div style="color: #ccc; margin-bottom: 5px;">${address || 'Address not available'}</div>
                            ${contactHtml}
                            ${distance ? `<div style="color: #aaa; font-size: 0.9em;">${distance} away</div>` : ''}
                        </div>`;
                }).join('');

                listElement.innerHTML = listItems;
            }

            // Initialize map
            async function initMap() {
                if (!appState.mapInstance) {
                    // Force map container to be visible temporarily to calculate dimensions
                    const mapElement = document.getElementById('map');
                    const wasHidden = mapElement.style.display === 'none';
                    if (wasHidden) {
                        mapElement.style.display = 'block';
                    }
                    
                    // Initialize the map
                    appState.mapInstance = L.map('map', {
                        center: [0, 0],
                        zoom: 13,
                        zoomControl: true,
                        attributionControl: false
                    });
                    
                    // Add tile layer
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(appState.mapInstance);
                    
                    // Add zoom control with better positioning
                    L.control.zoom({
                        position: 'topright'
                    }).addTo(appState.mapInstance);
                    
                    // Hide map again if it was hidden
                    if (wasHidden) {
                        mapElement.style.display = 'none';
                    }
                    
                    appState.mapShown = true;
                    appState.placeMarkers = [];
                    
                    // Force resize of map after a short delay
                    setTimeout(() => {
                        if (appState.mapInstance) {
                            appState.mapInstance.invalidateSize();
                        }
                    }, 100);
                }
                return appState.mapInstance;
            }

            // Update location display
            async function updateLocationDisplay(position) {
                if (!position?.coords) return;
                
                appState.lastKnownPosition = position;
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                // Fetch nearby places when location updates significantly
                if (!appState.lastFetchedLocation || 
                    (Math.abs(appState.lastFetchedLocation.lat - lat) > 0.01 || 
                     Math.abs(appState.lastFetchedLocation.lon - lon) > 0.01)) {
                    
                    appState.lastFetchedLocation = { lat, lon };
                    const places = await fetchNearbyPlaces(lat, lon, 2000); // 2km radius
                    if (appState.mapInstance) {
                        addPlaceMarkers(places);
                    }
                }
                
                // Update accuracy indicator
                if (accuracyDot && accuracyText) {
                    if (accuracy < 20) {
                        accuracyDot.className = 'accuracy-dot accuracy-good';
                    } else if (accuracy < 50) {
                        accuracyDot.className = 'accuracy-dot accuracy-medium';
                    } else {
                        accuracyDot.className = 'accuracy-dot';
                    }
                    accuracyText.textContent = `Accuracy: ${Math.round(accuracy)} m`;
                }
                
                // Update map if available
                if (appState.mapInstance) {
                    if (!appState.currentMarker) {
                        appState.currentMarker = L.marker([lat, lon]).addTo(appState.mapInstance);
                    } else {
                        appState.currentMarker.setLatLng([lat, lon]);
                    }
                    appState.mapInstance.setView([lat, lon], 15);
                }
                
                // Update status
                if (locationStatus) {
                    locationStatus.innerHTML = `
                        <p style="margin: 5px 0;">
                            Lat: ${lat.toFixed(6)}<br>
                            Lng: ${lon.toFixed(6)}<br>
                            Accuracy: ${Math.round(accuracy)} meters
                        </p>
                    `;
                }
                
                // Update timestamp
                if (lastUpdate) {
                    lastUpdate.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                }
            }

            // Get high accuracy position with timeout
            function getHighAccuracyPosition() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation is not supported by your browser'));
                        return;
                    }

                    const options = {
                        enableHighAccuracy: true,  // Use GPS if available
                        timeout: 15000,           // Wait up to 15 seconds
                        maximumAge: 0             // Don't use a cached position
                    };

                    navigator.geolocation.getCurrentPosition(
                        position => resolve(position),
                        error => reject(error),
                        options
                    );
                });
            }

            // Start watching position with high accuracy
            function startWatchingPosition() {
                if (appState.watchId !== null) return;
                
                // First get a high accuracy position immediately
                getHighAccuracyPosition()
                    .then(position => {
                        updateLocationDisplay(position);
                    })
                    .catch(error => {
                        console.warn('High accuracy position not available:', error);
                        // Continue with watchPosition even if initial high accuracy fails
                    });
                
                // Then set up the watcher with high accuracy
                const options = {
                    enableHighAccuracy: true,  // Request high accuracy
                    timeout: 15000,           // 15 second timeout
                    maximumAge: 0,            // Don't use cached position
                    distanceFilter: 0          // Get all position updates
                };
                
                // First try to get a high accuracy position
                navigator.geolocation.getCurrentPosition(
                    initialPosition => {
                        if (initialPosition.coords.accuracy <= 30) {
                            updateLocationDisplay(initialPosition);
                        }
                    },
                    null,
                    { ...options, timeout: 20000 }
                );
                
                // Then watch for position updates
                appState.watchId = navigator.geolocation.watchPosition(
                    position => {
                        console.log('Position update:', {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date(position.timestamp).toISOString()
                        });
                        
                        // Only update if we have good accuracy (30m or better)
                        if (position.coords.accuracy <= 30) {
                            updateLocationDisplay(position);
                            if (appState.isSharingLiveLocation) {
                                console.log("Updating live location...");
                            }
                        } else if (locationStatus) {
                            locationStatus.innerHTML = `
                                <p style="color:#ff9900;">
                                    Low accuracy: ${Math.round(position.coords.accuracy)}m. 
                                    Moving to an open area may help.
                                </p>`;
                        }
                    },
                    error => {
                        console.error("Geolocation error:", error);
                        if (locationStatus) {
                            let errorMessage = `Error: ${error.message}`;
                            if (error.code === error.PERMISSION_DENIED) {
                                errorMessage = 'Location permission denied. Please enable location services in your browser settings.';
                            } else if (error.code === error.POSITION_UNAVAILABLE) {
                                errorMessage = 'Location information is unavailable. Please check your internet/GPS connection.';
                            } else if (error.code === error.TIMEOUT) {
                                errorMessage = 'Location request timed out. Please try again in an open area.';
                            }
                            
                            locationStatus.innerHTML = `
                                <p style="color:#ff4d4d;">
                                    ${errorMessage}
                                </p>`;
                        }
                    },
                    options
                );
            }

            // Stop watching position
            function stopWatchingPosition() {
                if (appState.watchId !== null) {
                    navigator.geolocation.clearWatch(appState.watchId);
                    appState.watchId = null;
                }
            }

            // Event Listeners
            // Start detection and camera automatically when the app loads
            startDetection();
            
            // Handle camera off button
            const cameraOffButton = document.getElementById('cameraOffButton');
            let isCameraOn = true;
            
            cameraOffButton.addEventListener('click', () => {
                isCameraOn = !isCameraOn;
                
                if (isCameraOn) {
                    // Turn camera back on
                    initCamera();
                    cameraOffButton.textContent = 'Turn Camera Off üî¥';
                    cameraOffButton.style.backgroundColor = '#ff4d4d';
                    video.style.display = 'block';
                    startDetection();
                } else {
                    // Turn camera off
                    if (appState.currentStream) {
                        appState.currentStream.getTracks().forEach(track => track.stop());
                        video.style.display = 'none';
                        cleanupAudio();
                        cameraOffButton.textContent = 'Turn Camera On üü¢';
                        cameraOffButton.style.backgroundColor = '#4CAF50';
                    }
                }
            });

            switchButton.addEventListener("click", () => {
                appState.useRearCamera = !appState.useRearCamera;
                initCamera();
            });

            showMapButton.addEventListener("click", async () => {
                appState.mapShown = !appState.mapShown;
                if (mapDiv) {
                    mapDiv.style.display = appState.mapShown ? "block" : "none";
                    if (appState.mapShown) {
                        await initMap();
                        // Force map resize after display
                        setTimeout(() => {
                            if (appState.mapInstance) {
                                appState.mapInstance.invalidateSize(true);
                            }
                        }, 100);
                        
                        if (appState.lastKnownPosition) {
                            updateLocationDisplay(appState.lastKnownPosition);
                        }
                    }
                }
            });

            shareLocationButton.addEventListener("click", async () => {
                if (!appState.lastKnownPosition) {
                    alert('Please wait while we get your location...');
                    return;
                }

                const { latitude, longitude, accuracy } = appState.lastKnownPosition.coords;
                const mapsUrl = `https://www.google.com/maps?q=${latitude},${longitude}`;
                const shareText = `I'm currently at this location (Accuracy: ${Math.round(accuracy)}m): ${mapsUrl}`;
                
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'My Current Location',
                            text: shareText,
                            url: mapsUrl
                        });
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.error('Error sharing:', err);
                            // Fallback to copying to clipboard
                            await navigator.clipboard.writeText(shareText);
                            alert('Link copied to clipboard!');
                        }
                    }
                } else if (navigator.clipboard) {
                    // Fallback for browsers that don't support Web Share API
                    try {
                        await navigator.clipboard.writeText(shareText);
                        alert('Location link copied to clipboard!');
                    } catch (err) {
                        console.error('Failed to copy:', err);
                        prompt('Copy this link:', mapsUrl);
                    }
                } else {
                    // Last resort fallback
                    prompt('Copy this link:', mapsUrl);
                }
            });

            // Initialize threshold display
            if (thresholdRange && thresholdValue) {
                thresholdRange.addEventListener("input", () => {
                    thresholdValue.textContent = thresholdRange.value;
                });
            }

            // Initialize app
            async function initApp() {
                initCamera();
                
                // Request location permission first
                try {
                    const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                    if (permissionStatus.state === 'granted') {
                        startWatchingPosition();
                    } else if (permissionStatus.state === 'prompt') {
                        // If we need to ask for permission, show a message
                        locationStatus.innerHTML = '<p>Please allow location access for accurate results...</p>';
                        startWatchingPosition();
                    } else {
                        locationStatus.innerHTML = `
                            <p style="color:#ff9900;">
                                Location permission denied. Please enable location services for accurate results.
                            </p>`;
                    }
                } catch (error) {
                    console.error('Error checking location permission:', error);
                    // Fallback to regular watch if permissions API not available
                    startWatchingPosition();
                }
                
                // Initialize map if not already initialized
                if (!appState.mapInstance) {
                    await initMap();
                }
            }

            // Start the app when window loads
            window.addEventListener("load", initApp);
        });
    </script>
</body>
</html>
